{% extends "app/layouts/home.html" %}
{% block styles %}
<!-- Add any page specific styles here -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block content %}
<div class="alert alert-success alert-dismissible fade in" role="alert" id="success-message" hidden>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span>
    </button>
    <span id="message"></span>
</div>
<div class="alert alert-info alert-dismissible fade in" role="alert">
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">×</span>
    </button>
    These are the Evaluation Panels submitted by other guides who are mentoring for the same PhD you are mentoring. For
    PhDs which are mentored by more than one guide, any guide/co-guide can submit the panel members which must be approved
    by all the guides/co-guides before it can be submitted to the Director.
</div>
<div class="x_panel">
    <div class="x_title">
        <h2>Evaluation Panels pending for your approval</h2>
        <div class="clearfix"></div>
    </div>
    <div class="x_content">
        <div class="accordion" id="accordion" role="tablist" aria-multiselectable="true">
            {% for thesis in all_thesis %}
            <div class="panel" id="thesis-{{ thesis.id }}">
                <a class="panel-heading collapsed" role="tab" id="heading{{ thesis.id }}" data-toggle="collapse" data-parent="#accordion" 
                   href="#collapse{{ thesis.id }}" aria-expanded="false" aria-controls="collapse{{ thesis.id }}">
                    <h4 class="panel-title">GPS Clustering</h4>
                </a>
                <div id="collapse{{ thesis.id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading{{ thesis.id }}">
                    <div class="panel-body">
                        <p><b>Title</b> - {{ thesis.title }}</p>
                        <p><b>Student</b> - <a href="{% url 'user_profile' %}">{{ thesis.student_full_name }}</a></p>
                        <p><b>Abstract</b> - {{ thesis.abstract }}</p>
                        <p>
                            <b>Keywords</b> -
                            <ul>
                                {% for keyword in thesis.keywords %}
                                <li>{{ keyword.title }}</li>
                                {% endfor %}
                            </ul> 
                        </p>
                        <br />
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="foreign-referees-{{ thesis.id }}" class="col-sm-2 control-label">
                                    Select Foreign Referees
                                </label>
                                <div class="col-sm-10">
                                    <select class="form-control select2-foreign" id="foreign-referees-{{ thesis.id }}" multiple>
                                        {% for referee in thesis.foreign_referees %}
                                        <option value="{{ referee.id }}" selected>{{ referee.full_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="indian-referees-2" class="col-sm-2 control-label">
                                    Select Indian Referees
                                </label>
                                <div class="col-sm-10">
                                    <select class="form-control select2-indian" id="indian-referees-{{ thesis.id }}" multiple>
                                        {% for referee in thesis.indian_referees %}
                                        <option value="{{ referee.id }}" selected>{{ referee.full_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="panel-feedback-{{ thesis.id }}" class="col-sm-2 control-label">
                                    Feedback
                                </label>
                                <div class="col-sm-10">
                                    <textarea class="form-control" id="panel-feedback-{{ thesis.id }}" rows="5"></textarea>
                                </div>
                            </div>
                        </form>
                        <br />
                        <!-- enhancement : enable this button only if there's a change in the panel -->
                        <button class="btn btn-primary pull-right"
                                onclick="submitPanel({{ thesis.id }}, '{% url 'guide_edit_panel_members' %}', '{{ csrf_token }}')">
                                <i class="fa fa-pencil-square-o"></i> &nbsp; Submit Changes in Panel
                        </button>
                        <button class="btn btn-success pull-left"
                                onclick="approveOrRejectPanel({{ thesis.id }}, '{% url 'guide_approve_panel_members' %}', '{{ csrf_token }}')">
                                <i class="fa fa-check"></i> &nbsp; Approve Evaluation Panel
                        </button>
                        <center>
                            <button class="btn btn-danger center"
                                onclick="approveOrRejectPanel({{ thesis.id }}, '{% url 'guide_reject_panel_members' %}', '{{ csrf_token }}')">
                                <i class="fa fa-close"></i> &nbsp; Reject Evaluation Panel
                            </button>
                        </center>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- dummy option only for reference -->
            <div class="panel" id="thesis-2">
                <a class="panel-heading collapsed" role="tab" id="heading2" data-toggle="collapse" data-parent="#accordion" 
                   href="#collapse2" aria-expanded="false" aria-controls="collapse2">
                    <h4 class="panel-title">GPS Clustering (Dummy)</h4>
                </a>
                <div id="collapse2" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading2">
                    <div class="panel-body">
                        <p><b>Title</b> - GPS Clustering</p>
                        <p><b>Student</b> - <a href="/user/profile/rit2013063/">Vamsi Sangam</a></p>
                        <p><b>Abstract</b> - ojjdsnldsnlsdncdsn</p>
                        <br />
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label for="foreign-referees-2" class="col-sm-2 control-label">
                                    Select Foreign Referees
                                </label>
                                <div class="col-sm-10">
                                    <select class="form-control select2-foreign" id="foreign-referees-2" multiple>
                                        <option value="2" selected>Naruto Uzumaki</option>
                                        <option value="3" selected>Kurosaki Ichigo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="indian-referees-2" class="col-sm-2 control-label">
                                    Select Indian Referees
                                </label>
                                <div class="col-sm-10">
                                    <select class="form-control select2-indian" id="indian-referees-2" multiple>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="panel-feedback-2" class="col-sm-2 control-label">
                                    Feedback
                                </label>
                                <div class="col-sm-10">
                                    <textarea class="form-control" id="panel-feedback-2" rows="5"></textarea>
                                </div>
                            </div>
                        </form>
                        <br />
                        <!-- enhancement : enable this button only if there's a change in the panel -->
                        <button class="btn btn-primary pull-right" id="submit-changes-2"
                                onclick="submitPanel(2, '{% url 'guide_edit_panel_members' %}', '{{ csrf_token }}')">
                                <i class="fa fa-pencil-square-o"></i> &nbsp; Submit Changes in Panel
                        </button>
                        <button class="btn btn-success pull-left" id="submit-changes-2"
                                onclick="submitPanel(2, '{% url 'guide_approve_panel_members' %}', '{{ csrf_token }}')">
                                <i class="fa fa-check"></i> &nbsp; Approve Evaluation Panel
                        </button>
                        <center>
                            <button class="btn btn-danger center" id="submit-changes-2"
                                onclick="submitPanel(2, '{% url 'guide_reject_panel_members' %}', '{{ csrf_token }}')">
                                <i class="fa fa-close"></i> &nbsp; Reject Evaluation Panel
                            </button>
                        </center>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<!-- Add any page specific javascript files here -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
<script>
    function formatRefereeData(user) {
        var option = $(
          '<span class="clearfix">' +
            '<img class="img-responsive img-rounded pull-right" style="height:65px;" src="http://localhost:8000/static/app/images/user.png"/>' +
            '<h5>' + user.text + '</h5>' +
            '<p>' + user.email_id + '</p>' +
          '</span>'
        );
        return option;
    };

    function formatRefereeSelection(referee) {
        return referee.text;
    }

    $(document).ready(function () {
        var select2Parameters = {
            ajax: {
                url: '/guide/panel/referees/foreign/',
                dataType: 'json',
                processResults: function (data, params) {
                    return {
                        results: data,
                    };
                },
            },
            // placeholder: "Select Panel Member",
            minimumInputLength: 1,
            maximumSelectionSize: 10,
            templateResult: formatRefereeData,
            templateSelection: formatRefereeSelection,
            width: '100%',
        };

        $(".select2-foreign").select2(select2Parameters);
        select2Parameters.ajax.url = '/guide/panel/referees/indian/';
        $(".select2-indian").select2(select2Parameters);
    });

    function submitPanel(id, url, csrf_token) {
        $.post(url, {
            'id' : id,
            'indian_referees': $('#indian-referees-' + id).val(),
            'foreign_referees': $('#foreign-referees-' + id).val(),
            'csrfmiddlewaretoken' : csrf_token
        }, function(data) {
            if (data.status === "OK") {
                $('#success-message #message').html(data.message);
                $('#success-message').show();
                $('#success-message').delay(3000).fadeOut();
                $('#thesis-' + id).fadeOut();
            }
        });
    }

    function approveOrRejectPanel(id, url, csrf_token) {
        $.post(url, {
            'id': id,
            'csrfmiddlewaretoken': csrf_token
        }, function (data) {
            if (data.status === "OK") {
                $('#success-message #message').html(data.message);
                $('#success-message').show();
                $('#success-message').delay(3000).fadeOut();
                $('#thesis-' + id).fadeOut();
            }
        });
    }
</script>
{% endblock %}